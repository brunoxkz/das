/**
 * TESTE COMPLETO DO SISTEMA ANTI-FRAUDE DE CR√âDITOS
 * Valida: pausar campanhas, impedir cria√ß√£o, reativar com cr√©ditos, detec√ß√£o autom√°tica de leads
 * Data: 11 de Janeiro de 2025
 */

const http = require('http');
const Database = require('better-sqlite3');
const path = require('path');

// Conectar ao banco de dados
const dbPath = path.join(__dirname, 'vendzz-database.db');
const db = new Database(dbPath);

// Configura√ß√µes
const BASE_URL = 'http://localhost:5000';
const TEST_USER = {
  email: 'admin@vendzz.com',
  password: 'admin123'
};

// Cores para output
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  red: '\x1b[31m',
  blue: '\x1b[34m',
  yellow: '\x1b[33m',
  cyan: '\x1b[36m',
  magenta: '\x1b[35m',
  gray: '\x1b[90m'
};

function log(message, color = 'reset') {
  const timestamp = new Date().toLocaleTimeString();
  console.log(`${colors.gray}[${timestamp}]${colors.reset} ${colors[color]}${message}${colors.reset}`);
}

// Fun√ß√£o para fazer requisi√ß√µes HTTP
function makeRequest(method, path, data = null, token = null) {
  return new Promise((resolve, reject) => {
    const options = {
      hostname: 'localhost',
      port: 5000,
      path: path,
      method: method,
      headers: {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` })
      }
    };

    const req = http.request(options, (res) => {
      let body = '';
      res.on('data', chunk => body += chunk);
      res.on('end', () => {
        try {
          const response = JSON.parse(body);
          resolve({ status: res.statusCode, data: response });
        } catch (e) {
          resolve({ status: res.statusCode, data: body });
        }
      });
    });

    req.on('error', reject);
    
    if (data) {
      req.write(JSON.stringify(data));
    }
    
    req.end();
  });
}

// Fun√ß√£o de autentica√ß√£o
async function authenticate() {
  try {
    log('üîê Autenticando usu√°rio...', 'blue');
    const response = await makeRequest('POST', '/api/auth/login', TEST_USER);
    
    if (response.status === 200 && (response.data.accessToken || response.data.token)) {
      const token = response.data.accessToken || response.data.token;
      log('‚úÖ Autentica√ß√£o bem-sucedida', 'green');
      return { token, userId: response.data.user.id };
    }
    
    throw new Error(`Falha na autentica√ß√£o - Status: ${response.status}`);
  } catch (error) {
    log(`‚ùå Erro na autentica√ß√£o: ${error.message}`, 'red');
    throw error;
  }
}

// Fun√ß√£o para verificar cr√©ditos atuais
async function checkCredits(token) {
  try {
    log('\nüí∞ VERIFICANDO CR√âDITOS ATUAIS', 'blue');
    
    const smsResponse = await makeRequest('GET', '/api/sms-credits', null, token);
    const emailResponse = await makeRequest('GET', '/api/auth/verify', null, token);
    
    if (smsResponse.status === 200 && emailResponse.status === 200) {
      const smsCredits = smsResponse.data;
      const emailCredits = emailResponse.data.user.emailCredits || 0;
      const whatsappCredits = emailResponse.data.user.whatsappCredits || 0;
      
      log(`üìä SMS: ${smsCredits.remaining}/${smsCredits.total}`, 'cyan');
      log(`üìß Email: ${emailCredits}`, 'cyan');
      log(`üì± WhatsApp: ${whatsappCredits}`, 'cyan');
      
      return {
        sms: smsCredits.remaining,
        email: emailCredits,
        whatsapp: whatsappCredits
      };
    }
    
    throw new Error('Falha ao verificar cr√©ditos');
  } catch (error) {
    log(`‚ùå Erro ao verificar cr√©ditos: ${error.message}`, 'red');
    return null;
  }
}

// Fun√ß√£o para zerar cr√©ditos no banco de dados
function zeroCredits(userId) {
  try {
    log('\nüîß ZERANDO CR√âDITOS NO BANCO DE DADOS', 'yellow');
    
    // Zerar cr√©ditos do usu√°rio
    db.prepare('UPDATE users SET smsCredits = 0, emailCredits = 0, whatsappCredits = 0 WHERE id = ?').run(userId);
    
    log('‚úÖ Cr√©ditos zerados com sucesso', 'green');
    return true;
  } catch (error) {
    log(`‚ùå Erro ao zerar cr√©ditos: ${error.message}`, 'red');
    return false;
  }
}

// Fun√ß√£o para restaurar cr√©ditos
function restoreCredits(userId) {
  try {
    log('\nüîß RESTAURANDO CR√âDITOS NO BANCO DE DADOS', 'yellow');
    
    // Restaurar cr√©ditos do usu√°rio
    db.prepare('UPDATE users SET smsCredits = 100, emailCredits = 500, whatsappCredits = 200 WHERE id = ?').run(userId);
    
    log('‚úÖ Cr√©ditos restaurados com sucesso', 'green');
    return true;
  } catch (error) {
    log(`‚ùå Erro ao restaurar cr√©ditos: ${error.message}`, 'red');
    return false;
  }
}

// Teste 1: Tentar criar campanha SMS sem cr√©ditos
async function testSMSWithoutCredits(token) {
  try {
    log('\nüì± TESTE 1: Criar campanha SMS SEM CR√âDITOS', 'blue');
    
    const campaignData = {
      name: 'Teste SMS Sem Cr√©ditos',
      quizId: 'Fwu7L-y0L7eS8xA5sZQmq',
      message: 'Teste de mensagem SMS',
      triggerType: 'immediate',
      targetAudience: 'all',
      dateFilter: new Date('2020-01-01').toISOString().split('T')[0]
    };
    
    const response = await makeRequest('POST', '/api/sms-campaigns', campaignData, token);
    
    if (response.status === 402) {
      log('‚úÖ Sistema bloqueou cria√ß√£o sem cr√©ditos (HTTP 402)', 'green');
      log(`üìÑ Resposta: ${JSON.stringify(response.data)}`, 'cyan');
      return { success: true, blocked: true };
    } else {
      log(`‚ùå Sistema permitiu cria√ß√£o sem cr√©ditos - Status: ${response.status}`, 'red');
      return { success: false, blocked: false };
    }
  } catch (error) {
    log(`‚ùå Erro no teste SMS: ${error.message}`, 'red');
    return { success: false, error: error.message };
  }
}

// Teste 2: Tentar criar campanha Email sem cr√©ditos
async function testEmailWithoutCredits(token) {
  try {
    log('\nüìß TESTE 2: Criar campanha EMAIL SEM CR√âDITOS', 'blue');
    
    const campaignData = {
      name: 'Teste Email Sem Cr√©ditos',
      quizId: 'Fwu7L-y0L7eS8xA5sZQmq',
      subject: 'Teste de email',
      content: 'Conte√∫do de teste',
      targetAudience: 'all',
      dateFilter: new Date('2020-01-01').toISOString().split('T')[0]
    };
    
    const response = await makeRequest('POST', '/api/email-campaigns', campaignData, token);
    
    if (response.status === 402) {
      log('‚úÖ Sistema bloqueou cria√ß√£o sem cr√©ditos (HTTP 402)', 'green');
      log(`üìÑ Resposta: ${JSON.stringify(response.data)}`, 'cyan');
      return { success: true, blocked: true };
    } else {
      log(`‚ùå Sistema permitiu cria√ß√£o sem cr√©ditos - Status: ${response.status}`, 'red');
      return { success: false, blocked: false };
    }
  } catch (error) {
    log(`‚ùå Erro no teste Email: ${error.message}`, 'red');
    return { success: false, error: error.message };
  }
}

// Teste 3: Tentar criar campanha WhatsApp sem cr√©ditos
async function testWhatsAppWithoutCredits(token) {
  try {
    log('\nüì± TESTE 3: Criar campanha WHATSAPP SEM CR√âDITOS', 'blue');
    
    const campaignData = {
      name: 'Teste WhatsApp Sem Cr√©ditos',
      quizId: 'Fwu7L-y0L7eS8xA5sZQmq',
      messages: ['Teste de mensagem WhatsApp'],
      targetAudience: 'all',
      dateFilter: new Date('2020-01-01').toISOString().split('T')[0]
    };
    
    const response = await makeRequest('POST', '/api/whatsapp-campaigns', campaignData, token);
    
    if (response.status === 402) {
      log('‚úÖ Sistema bloqueou cria√ß√£o sem cr√©ditos (HTTP 402)', 'green');
      log(`üìÑ Resposta: ${JSON.stringify(response.data)}`, 'cyan');
      return { success: true, blocked: true };
    } else {
      log(`‚ùå Sistema permitiu cria√ß√£o sem cr√©ditos - Status: ${response.status}`, 'red');
      return { success: false, blocked: false };
    }
  } catch (error) {
    log(`‚ùå Erro no teste WhatsApp: ${error.message}`, 'red');
    return { success: false, error: error.message };
  }
}

// Teste 4: Criar campanhas COM cr√©ditos ap√≥s restaura√ß√£o
async function testCreateWithCredits(token) {
  try {
    log('\nüí≥ TESTE 4: Criar campanhas COM CR√âDITOS', 'blue');
    
    const results = {};
    
    // Teste SMS
    const smsData = {
      name: 'Teste SMS Com Cr√©ditos',
      quizId: 'Fwu7L-y0L7eS8xA5sZQmq',
      message: 'Teste de mensagem SMS',
      triggerType: 'immediate',
      targetAudience: 'all',
      dateFilter: new Date('2020-01-01').toISOString().split('T')[0]
    };
    
    const smsResponse = await makeRequest('POST', '/api/sms-campaigns', smsData, token);
    results.sms = {
      status: smsResponse.status,
      success: smsResponse.status === 200 || smsResponse.status === 201,
      data: smsResponse.data
    };
    
    // Teste Email
    const emailData = {
      name: 'Teste Email Com Cr√©ditos',
      quizId: 'Fwu7L-y0L7eS8xA5sZQmq',
      subject: 'Teste de email',
      content: 'Conte√∫do de teste',
      targetAudience: 'all',
      dateFilter: new Date('2020-01-01').toISOString().split('T')[0]
    };
    
    const emailResponse = await makeRequest('POST', '/api/email-campaigns', emailData, token);
    results.email = {
      status: emailResponse.status,
      success: emailResponse.status === 200 || emailResponse.status === 201,
      data: emailResponse.data
    };
    
    // Teste WhatsApp
    const whatsappData = {
      name: 'Teste WhatsApp Com Cr√©ditos',
      quizId: 'Fwu7L-y0L7eS8xA5sZQmq',
      messages: ['Teste de mensagem WhatsApp'],
      targetAudience: 'all',
      dateFilter: new Date('2020-01-01').toISOString().split('T')[0]
    };
    
    const whatsappResponse = await makeRequest('POST', '/api/whatsapp-campaigns', whatsappData, token);
    results.whatsapp = {
      status: whatsappResponse.status,
      success: whatsappResponse.status === 200 || whatsappResponse.status === 201,
      data: whatsappResponse.data
    };
    
    // Resultados
    log(`üì± SMS: ${results.sms.success ? '‚úÖ Criada' : '‚ùå Falhou'} (Status: ${results.sms.status})`, results.sms.success ? 'green' : 'red');
    log(`üìß Email: ${results.email.success ? '‚úÖ Criada' : '‚ùå Falhou'} (Status: ${results.email.status})`, results.email.success ? 'green' : 'red');
    log(`üì± WhatsApp: ${results.whatsapp.success ? '‚úÖ Criada' : '‚ùå Falhou'} (Status: ${results.whatsapp.status})`, results.whatsapp.success ? 'green' : 'red');
    
    return results;
  } catch (error) {
    log(`‚ùå Erro no teste com cr√©ditos: ${error.message}`, 'red');
    return { error: error.message };
  }
}

// Teste 5: Verificar detec√ß√£o autom√°tica de leads
async function testAutoLeadDetection() {
  try {
    log('\nü§ñ TESTE 5: DETEC√á√ÉO AUTOM√ÅTICA DE LEADS', 'blue');
    
    // Contar campanhas SMS ativas
    const smsCampaigns = db.prepare('SELECT COUNT(*) as count FROM sms_campaigns WHERE status = ?').get('active');
    log(`üì± Campanhas SMS ativas: ${smsCampaigns.count}`, 'cyan');
    
    // Contar campanhas WhatsApp ativas
    const whatsappCampaigns = db.prepare('SELECT COUNT(*) as count FROM whatsapp_campaigns WHERE status = ?').get('active');
    log(`üì± Campanhas WhatsApp ativas: ${whatsappCampaigns.count}`, 'cyan');
    
    // Contar campanhas Email ativas
    const emailCampaigns = db.prepare('SELECT COUNT(*) as count FROM email_campaigns WHERE status = ?').get('active');
    log(`üìß Campanhas Email ativas: ${emailCampaigns.count}`, 'cyan');
    
    // Verificar se h√° respostas recentes de quiz
    const recentResponses = db.prepare(`
      SELECT COUNT(*) as count 
      FROM quiz_responses 
      WHERE submittedAt > datetime('now', '-1 hour')
    `).get();
    log(`üìä Respostas recentes (1h): ${recentResponses.count}`, 'cyan');
    
    // Verificar leads agendados
    const scheduledSMS = db.prepare('SELECT COUNT(*) as count FROM sms_logs WHERE status = ?').get('scheduled');
    log(`üì± SMS agendados: ${scheduledSMS.count}`, 'cyan');
    
    const scheduledWhatsApp = db.prepare('SELECT COUNT(*) as count FROM whatsapp_logs WHERE status = ?').get('scheduled');
    log(`üì± WhatsApp agendados: ${scheduledWhatsApp.count}`, 'cyan');
    
    return {
      success: true,
      activeCampaigns: {
        sms: smsCampaigns.count,
        whatsapp: whatsappCampaigns.count,
        email: emailCampaigns.count
      },
      recentResponses: recentResponses.count,
      scheduled: {
        sms: scheduledSMS.count,
        whatsapp: scheduledWhatsApp.count
      }
    };
  } catch (error) {
    log(`‚ùå Erro na verifica√ß√£o de detec√ß√£o autom√°tica: ${error.message}`, 'red');
    return { success: false, error: error.message };
  }
}

// Fun√ß√£o principal
async function runTests() {
  const startTime = Date.now();
  let results = {};
  
  log('üß™ INICIANDO TESTE COMPLETO DO SISTEMA ANTI-FRAUDE', 'magenta');
  log('============================================================', 'gray');
  
  try {
    // 1. Autentica√ß√£o
    const auth = await authenticate();
    const { token, userId } = auth;
    
    // 2. Verificar cr√©ditos iniciais
    const initialCredits = await checkCredits(token);
    results.initialCredits = initialCredits;
    
    // 3. Zerar cr√©ditos
    const creditsZeroed = zeroCredits(userId);
    if (!creditsZeroed) {
      throw new Error('Falha ao zerar cr√©ditos');
    }
    
    // 4. Verificar cr√©ditos ap√≥s zerar
    const zeroedCredits = await checkCredits(token);
    results.zeroedCredits = zeroedCredits;
    
    // 5. Testes sem cr√©ditos
    results.smsWithoutCredits = await testSMSWithoutCredits(token);
    results.emailWithoutCredits = await testEmailWithoutCredits(token);
    results.whatsappWithoutCredits = await testWhatsAppWithoutCredits(token);
    
    // 6. Restaurar cr√©ditos
    const creditsRestored = restoreCredits(userId);
    if (!creditsRestored) {
      throw new Error('Falha ao restaurar cr√©ditos');
    }
    
    // 7. Verificar cr√©ditos ap√≥s restaurar
    const restoredCredits = await checkCredits(token);
    results.restoredCredits = restoredCredits;
    
    // 8. Testes com cr√©ditos
    results.createWithCredits = await testCreateWithCredits(token);
    
    // 9. Verificar detec√ß√£o autom√°tica
    results.autoDetection = await testAutoLeadDetection();
    
  } catch (error) {
    log(`‚ùå Erro durante os testes: ${error.message}`, 'red');
    results.error = error.message;
  } finally {
    db.close();
  }
  
  // Relat√≥rio final
  const duration = Date.now() - startTime;
  
  log('\n============================================================', 'gray');
  log('üìä RELAT√ìRIO FINAL DO SISTEMA ANTI-FRAUDE', 'magenta');
  log('============================================================', 'gray');
  
  log(`\n‚è±Ô∏è  Dura√ß√£o total: ${duration}ms`, 'gray');
  
  // Contabilizar sucessos
  let passed = 0;
  let total = 0;
  
  // Valida√ß√µes
  if (results.smsWithoutCredits?.blocked) { passed++; log('‚úÖ PASSOU - SMS bloqueado sem cr√©ditos', 'green'); } else { log('‚ùå FALHOU - SMS n√£o bloqueado sem cr√©ditos', 'red'); }
  total++;
  
  if (results.emailWithoutCredits?.blocked) { passed++; log('‚úÖ PASSOU - Email bloqueado sem cr√©ditos', 'green'); } else { log('‚ùå FALHOU - Email n√£o bloqueado sem cr√©ditos', 'red'); }
  total++;
  
  if (results.whatsappWithoutCredits?.blocked) { passed++; log('‚úÖ PASSOU - WhatsApp bloqueado sem cr√©ditos', 'green'); } else { log('‚ùå FALHOU - WhatsApp n√£o bloqueado sem cr√©ditos', 'red'); }
  total++;
  
  if (results.createWithCredits?.sms?.success) { passed++; log('‚úÖ PASSOU - SMS criado com cr√©ditos', 'green'); } else { log('‚ùå FALHOU - SMS n√£o criado com cr√©ditos', 'red'); }
  total++;
  
  if (results.createWithCredits?.email?.success) { passed++; log('‚úÖ PASSOU - Email criado com cr√©ditos', 'green'); } else { log('‚ùå FALHOU - Email n√£o criado com cr√©ditos', 'red'); }
  total++;
  
  if (results.createWithCredits?.whatsapp?.success) { passed++; log('‚úÖ PASSOU - WhatsApp criado com cr√©ditos', 'green'); } else { log('‚ùå FALHOU - WhatsApp n√£o criado com cr√©ditos', 'red'); }
  total++;
  
  if (results.autoDetection?.success) { passed++; log('‚úÖ PASSOU - Detec√ß√£o autom√°tica funcionando', 'green'); } else { log('‚ùå FALHOU - Detec√ß√£o autom√°tica com problemas', 'red'); }
  total++;
  
  const successRate = ((passed / total) * 100).toFixed(1);
  log(`\n‚úÖ Taxa de sucesso: ${passed}/${total} (${successRate}%)`, successRate >= 80 ? 'green' : 'red');
  
  if (successRate >= 80) {
    log('\nüéâ SISTEMA ANTI-FRAUDE APROVADO PARA PRODU√á√ÉO!', 'green');
  } else {
    log('\n‚ö†Ô∏è  SISTEMA ANTI-FRAUDE REQUER CORRE√á√ïES!', 'yellow');
  }
  
  // Detec√ß√£o autom√°tica
  if (results.autoDetection?.success) {
    log(`\nü§ñ DETEC√á√ÉO AUTOM√ÅTICA DE LEADS:`, 'cyan');
    log(`   üì± Campanhas SMS ativas: ${results.autoDetection.activeCampaigns.sms}`, 'cyan');
    log(`   üìß Campanhas Email ativas: ${results.autoDetection.activeCampaigns.email}`, 'cyan');
    log(`   üì± Campanhas WhatsApp ativas: ${results.autoDetection.activeCampaigns.whatsapp}`, 'cyan');
    log(`   üìä Respostas recentes: ${results.autoDetection.recentResponses}`, 'cyan');
    log(`   ‚è∞ SMS agendados: ${results.autoDetection.scheduled.sms}`, 'cyan');
    log(`   ‚è∞ WhatsApp agendados: ${results.autoDetection.scheduled.whatsapp}`, 'cyan');
  }
}

// Executar testes
runTests();